<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Git post-receive hooks, to check out code on a production server.">
<meta property="og:type" content="article">
<meta property="og:title" content="Dealing with git post receive hooks">
<meta property="og:url" content="http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/index.html">
<meta property="og:site_name" content="Joe Prisk">
<meta property="og:description" content="Git post-receive hooks, to check out code on a production server.">
<meta property="og:image" content="http://www.joeprisk.co.uk/hook.jpg">
<meta property="og:updated_time" content="2017-03-06T01:04:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dealing with git post receive hooks">
<meta name="twitter:description" content="Git post-receive hooks, to check out code on a production server.">
<meta name="twitter:image" content="http://www.joeprisk.co.uk/hook.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Dealing with git post receive hooks</title>
    <!-- styles -->
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/kernowjoe">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/netflix-hidden-categories/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/Get-up-Stand-up-adding-music-to-your-daily-stand-up/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&text=Dealing with git post receive hooks"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&is_video=false&description=Dealing with git post receive hooks"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Dealing with git post receive hooks&body=Check out this article: http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&name=Dealing with git post receive hooks&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Dealing with git post receive hooks
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Joe Prisk</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-10-11T00:00:28.000Z" itemprop="datePublished">2016-10-11</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/development/">development</a>, <a class="tag-link" href="/tags/git/">git</a>
    </div>


    </div>
  </header>
  
    <img src="/assets/hook.jpg" style="width:100%; height:20rem;object-fit:cover" alt="Dealing with git post receive hooks">

  

  <div class="content" itemprop="articleBody">
    <p>Git hooks can be used for a number of different uses, The main things we use them for are unit testing prior to a commit (pre-commit) and, checking out code on a remote repository after it receive a push (post-receive).</p>
<p><em>– We have since moved away from this method of using post-recieve hooks to check out code, as it only allows you to move forward and not backwards –</em></p>
<p>I’m going to briefly run through how we set up our post receive hook, on a remote repository, of a production server.</p>
<p>We set it up as a bare repository as it is one that will not be worked in, but purely receive code from a push.</p>
<p>A post-receive hook receives arguments from stdin as <code>&lt;oldrev&gt; &lt;newrev&gt; &lt;refname&gt;</code> not from stdout arguments. so to get these arguments we must use </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> oldrev newrev ref; <span class="keyword">do</span></div><div class="line">...</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>A post receive is run irrelevant of which branch is received, so we need to determine what the action should be. We use gitflow to keep our branching organised and in order, and stick to <a href="http://semver.org/" target="_blank" rel="external">semantic versioning</a> for our tags.<br>This makes it easy to rollback if any issues ever arise.</p>
<p>On a production server we would only check out a tagged version, as we have a clear point in code history to roll back to if at some point this is needed.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> GIT_WORK_TREE=/var/www/mywebsite.co.uk</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> oldrev newrev ref; <span class="keyword">do</span></div><div class="line"></div><div class="line">    branch=`<span class="built_in">echo</span> <span class="variable">$ref</span> | cut <span class="_">-d</span>/ <span class="_">-f</span>3`</div><div class="line"></div><div class="line">    <span class="comment"># Only ever check out a tag so there is always a clear roll back route</span></div><div class="line">    <span class="keyword">if</span> [[ <span class="variable">$branch</span> =~ ^[^0-9]*(([0-9]+\.)*[0-9]+)$ ]]; <span class="keyword">then</span></div><div class="line">        </div><div class="line">        <span class="comment"># match a tag eg. 1.1.1</span></div><div class="line">        git checkout <span class="_">-f</span> <span class="variable">$branch</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="comment"># Some other branch that should not be actioned on a live/production server</span></div><div class="line">        <span class="comment"># No action should be taken here</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">" -- NOT pushingchecking out <span class="variable">$branch</span>"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p><a href="https://gist.github.com/kernowjoe/436ee79cf95b1b1d8514d430892645c0" target="_blank" rel="external">github</a></p>
<p>As you can see the regex matches any tag, and will recurse through. </p>
<p>You could quite easily call a checkout function from here to perform build tasks etc, this is just a skeleton example of checking out the right branch at the right time.</p>
<p>small gotcha, alway remember to make the file executable otherwise you will be pulling your hair out trying to work out why nothing is happening!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod +x my-repository/hooks/post-receive</div></pre></td></tr></table></figure>
  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/kernowjoe">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&text=Dealing with git post receive hooks"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&is_video=false&description=Dealing with git post receive hooks"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Dealing with git post receive hooks&body=Check out this article: http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&title=Dealing with git post receive hooks"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.joeprisk.co.uk/Dealing-with-git-post-receive-hooks/&name=Dealing with git post receive hooks&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 Joe Prisk
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/kernowjoe">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'xx-xxxxxx-x', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


</body>
</html>
